<?xml version="1.0"?>

<polUni>
    <infraInfra>
        <vnsMDev vendor="NGINX" model="NGINX" version="0.0.1">

            <!-- - - - - - - - - - - - - - - - - - - - - -->
            <!--              GENERIC PART               -->
            <!-- - - - - - - - - - - - - - - - - - - - - -->

            <!-- Script -->
            <!-- TODO: complete versionExpr -->
            <vnsDevScript name="NGINX"
                          ctrlrVersion="1.0"
                          minorversion="1"
                          versionExpr="0.0.1"
                          packageName="DeviceScript.py"/>

            <!-- Credentials -->
            <vnsMCred name="username" key="username"/>
            <vnsMCredSecret name="password" key="password"/>

            <!-- Interfaces -->
            <vnsMIfLbl name="external" shortName="ext"/>
            <vnsMIfLbl name="internal" shortName="int"/>
            <vnsMIfLbl name="management" shortName="mgmt"/>


            <!-- Parameter validation -->

            <!-- TODO : Test regex more in depth! -->
            <!-- From 1.0.0.1 to 223.255.255.254, exception 127.x.x.x -->
            <vnsComparison name="isIPv4Addr" cmp="match" value="^(?!127)(?!1\.0\.0\.0)(?!223\.255\.255\.255)(2[0-2][0-3]|[1]?[1-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$"/>
            <!--<vnsComparison name="ipv4Addr" cmp="match" value="^([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])(\.([01]?[0-9]?[0-9]|2[0-4][0-9]|25[0-5])){3}$"/>-->

            <vnsComposite comp="or" name="isLBAlgo">
                <vnsComparison cmp="eq" name="round-robin" value="round-robin"/>
                <vnsComparison cmp="eq" name="least-con" value="least-con"/>
                <vnsComparison cmp="eq" name="least-time" value="least-time"/>
                <vnsComparison cmp="eq" name="ip_hash" value="ip_hash"/>
                <vnsComparison cmp="eq" name="hash" value="hash"/>
            </vnsComposite>

            <vnsComposite comp="or" name="isBoolean">
                <vnsComparison cmp="match" name="true" value="true"/>
                <vnsComparison cmp="match" name="false" value="false"/>
            </vnsComposite>


            <!-- - - - - - - - - - - - - - - - - - - - - -->
            <!--  CLUSTER AND DEVICE CONFIGURATION PART  -->
            <!-- - - - - - - - - - - - - - - - - - - - - -->

            <vnsClusterCfg name="Cluster">
                <vnsDevCfg name="Device">

                </vnsDevCfg>
            </vnsClusterCfg>



            <!-- - - - - - - - - - - - - - - - - - - - - -->
            <!--             FUNCTIONAL PART             -->
            <!-- - - - - - - - - - - - - - - - - - - - - -->

            <!-- Global functional device configuration -->
            <vnsMDevCfg name="DeviceConfig">

                <!-- Server pool (backend) -->
                <vnsMFolder key="upstream"
                            description="Configure the backend (upstream)"
                            dispLabel="Configure the backend (upstream)"
                            dispFeature="Server"
                            cardinality="n">
                            <!--scopedBy="epg"-->

                    <vnsMParam key="upstreamName" description="Name of the backend" mandatory="true" dType="str" dispLabel="Name of the backend"/>

                    <vnsMParam key="lbalgo" description="Load-balancing algorithm" mandatory="false" dType="str" dispLabel="Load-balancing algorithm" validation="isLBAlgo"/>

                    <vnsMFolder key="server"
                                description="Server of a backend"
                                dispLabel="Server"
                                cardinality="n"
                                dispFeature="LB">
                                <!--scopedBy="epg"-->
                        <!-- Connectivity -->
                        <vnsMParam key="ip" description="Address of the server" mandatory="true" dType="str" dispLabel="Address of the server" validation="isIPv4Addr"/>
                        <vnsMParam key="port" description="Port of the server" mandatory="false" dType="str" dispLabel="Port of the server"/>

                        <!-- Parameters -->
                        <vnsMParam key="weight" description="Weight given to the server" mandatory="false" dType="str" dispLabel="Weight given to the server"/>
                        <vnsMParam key="max_fails" description="Maximum number of unsuccessful attempts during fail_timeout" mandatory="false" dType="str" dispLabel="Maximum number of unsuccessful attempts during fail_timeout"/>
                        <vnsMParam key="fail_timeout" description="Consider the server unavailable if max_fails is reached during this time" mandatory="false" dType="str" dispLabel="Consider the server unavailable if max_fails is reached during this time"/>
                        <vnsMParam key="backup" description="Mark the server as a backup" mandatory="false" dType="str" dispLabel="Mark the server as a backup" validation="isBoolean"/>
                        <!-- TODO : Continue the list of parameters : http://nginx.org/en/docs/http/ngx_http_upstream_module.html#server -->

                    </vnsMFolder>
                </vnsMFolder>

                <!-- Server Load Balancer -->
                <vnsMFolder key="lbserver"
                            description="Configure the Server Load Balancer"
                            dispLabel="Configure the Server Load Balancer"
                            cardinality="n">
                            <!--scopedBy="epg"-->
                    <vnsMParam key="name" description="Name" mandatory="true" dType="str" dispLabel="Name"/>
                    <vnsMParam key="ip" description="IP address" mandatory="true" dType="str" dispLabel="IP address" validation="isIPv4Addr"/>
                    <vnsMParam key="port" description="Port" mandatory="false" dType="str" dispLabel="Port"/>

                </vnsMFolder>


            </vnsMDevCfg>

            <!-- Group configuration -->
            <!--<vnsGrpCfg>-->

            <!--</vnsGrpCfg>-->



            <!-- Function configuration : Load balancer -->
            <vnsMFunc name="Load_balancer">

                <!-- Image -->
                <vnsMImage name="cisco.gif"/>

                <!-- Connector Objects -->
                <vnsMConn name="internal" encType="vlan" dir="output">
                    <vnsRsInterface tDn="uni/infra/mDev-NGINX-NGINX-0.0.1/mIfLbl-internal"/>
                </vnsMConn>

                <vnsMConn name="external" encType="vlan" dir="input">
                    <vnsRsInterface tDn="uni/infra/mDev-NGINX-NGINX-0.0.1/mIfLbl-external"/>
                </vnsMConn>

                <!-- Features -->
                <vnsMFeature name="Server" dispOrder="0"/>
                <vnsMFeature name="LB" dispOrder="1"/>
                <vnsMFeature name="Policy" dispOrder="2"/>

                <!-- Folders -->
                <vnsMFolder key="upstreamCfg"
                            description="backend"
                            dispLabel="backend"
                            dispFeature="Server"
                            cardinality="n">
                    <vnsMRel dispLabel="Select backend" key="upstreamRel">
                        <vnsRsTarget tDn="uni/infra/mDev-NGINX-NGINX-0.0.1/mDevCfg/mFolder-upstream"/>
                    </vnsMRel>
                </vnsMFolder>

                <vnsMFolder key="lbserverCfg"
                            description="Server Load Balancer"
                            dispLabel="Server Load Balancer"
                            dispFeature="LB">
                    <vnsMRel dispLabel="Select Server Load Balancer" key="lbserverRel">
                        <vnsRsTarget tDn="uni/infra/mDev-NGINX-NGINX-0.0.1/mDevCfg/mFolder-lbserver"/>
                    </vnsMRel>
                </vnsMFolder>


                <!-- TODO -->


            </vnsMFunc>




        </vnsMDev>
    </infraInfra>
</polUni>
